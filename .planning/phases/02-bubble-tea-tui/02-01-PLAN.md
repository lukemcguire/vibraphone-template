---
phase: 02-bubble-tea-tui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crawler/events.go
  - src/crawler/crawler.go
autonomous: true

must_haves:
  truths:
    - "Crawler emits progress events via channel instead of printing to stdout"
    - "Crawler constructor accepts an optional progress channel"
    - "All fmt.Printf calls removed from crawler.go"
  artifacts:
    - path: "src/crawler/events.go"
      provides: "CrawlEvent type for progress reporting"
      contains: "type CrawlEvent struct"
    - path: "src/crawler/crawler.go"
      provides: "Refactored crawler with event channel support"
      exports: ["New", "Run"]
  key_links:
    - from: "src/crawler/crawler.go"
      to: "src/crawler/events.go"
      via: "sends CrawlEvent to progress channel"
      pattern: "progressCh.*<-.*CrawlEvent"
---

<objective>
Refactor the crawler to emit progress events via a buffered channel instead of writing directly to stdout with fmt.Printf.

Purpose: The Bubble Tea TUI owns stdout. Any direct fmt.Printf from the crawler will corrupt TUI rendering. This plan creates the event bridge that the TUI will consume in Plan 02.

Output: Modified crawler.go (no stdout writes), new events.go (CrawlEvent type)
</objective>

<execution_context>
@/home/luke/.claude/get-shit-done/workflows/execute-plan.md
@/home/luke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-bubble-tea-tui/02-RESEARCH.md
@src/crawler/crawler.go
@src/crawler/worker.go
@src/result/result.go
@src/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CrawlEvent type and add progress channel to crawler</name>
  <files>src/crawler/events.go, src/crawler/crawler.go</files>
  <action>
Create src/crawler/events.go with:
- CrawlEvent struct containing: URL string, StatusCode int, Error string, Checked int (running total), Broken int (running total), IsExternal bool
- This is a simple data struct, no methods needed

Modify src/crawler/crawler.go:
1. Add `progressCh chan<- CrawlEvent` field to the Crawler struct
2. Change New() signature to `New(cfg Config, progressCh chan<- CrawlEvent) *Crawler`. The progressCh parameter can be nil (for backward compatibility / testing without TUI). Store it on the struct.
3. In the coordinator loop (lines 92-130), replace the three fmt.Printf calls (lines 101-106) with event sends. For each CrawlResult processed:
   - Build a CrawlEvent with the URL, status info, and running totals (c.total for Checked, len(c.results) for Broken)
   - If c.progressCh != nil, send the event: `c.progressCh <- event`
   - Do NOT print anything to stdout
4. Remove the "fmt" import if it becomes unused (it will since all fmt.Printf calls are removed from this file)

Important: Do NOT change the Run() method signature or return type. Only the internal behavior changes (events instead of prints).
  </action>
  <verify>
Run `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go vet ./crawler/...` -- must pass with no errors.
Run `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go build ./...` -- must compile. Note: main.go will fail because New() signature changed. That's expected and fixed in Task 2.
  </verify>
  <done>CrawlEvent type exists. Crawler struct has progressCh field. New() accepts progress channel. All fmt.Printf removed from crawler.go. `go vet ./crawler/...` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Update main.go to pass nil progress channel</name>
  <files>src/main.go</files>
  <action>
Update the crawler.New() call in main.go (line 45) to pass nil as the progress channel:
```go
c := crawler.New(cfg, nil)
```

This is a minimal bridge change. Plan 02 will replace this nil with a real channel when integrating the TUI.

Also remove the fmt.Printf on line 46 ("Crawling %s with %d workers...") -- this stdout write will also interfere with the TUI. The TUI will handle displaying crawl status. For now, just remove it so the tool runs silently until the TUI is added.

Keep the error output to stderr (lines 49-52) and the interrupt message (lines 54-56) for now -- stderr does not conflict with Bubble Tea. Plan 02 will replace these with TUI handling.
  </action>
  <verify>
Run `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go build -o /dev/null .` -- must compile successfully.
Run `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go vet ./...` -- must pass with no errors.
  </verify>
  <done>main.go compiles with updated New() call. No stdout writes from crawler during operation. `go build` and `go vet` pass for entire module.</done>
</task>

</tasks>

<verification>
1. `cd src && go vet ./...` passes -- no type errors, no unused imports
2. `cd src && go build -o /dev/null .` compiles successfully
3. grep -r "fmt.Printf" src/crawler/crawler.go returns no matches
4. src/crawler/events.go contains CrawlEvent struct
</verification>

<success_criteria>
- Crawler compiles and runs without printing to stdout
- CrawlEvent type defined with URL, status, running totals
- New() accepts optional progress channel (nil = no events)
- Full module builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-bubble-tea-tui/02-01-SUMMARY.md`
</output>
