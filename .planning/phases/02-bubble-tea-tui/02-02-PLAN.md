---
phase: 02-bubble-tea-tui
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/tui/model.go
  - src/tui/messages.go
  - src/tui/styles.go
  - src/main.go
autonomous: false

must_haves:
  truths:
    - "User sees live TUI with spinner, URLs checked count, broken links count during crawl"
    - "Tool displays pretty formatted summary table after crawl completes"
    - "User can gracefully stop crawl with Ctrl+C"
    - "Tool exits with code 0 when no broken links found"
    - "Tool exits with non-zero code when broken links found"
  artifacts:
    - path: "src/tui/model.go"
      provides: "Bubble Tea model with Init/Update/View"
      contains: "func (m model) Update"
      min_lines: 60
    - path: "src/tui/messages.go"
      provides: "TUI message types for crawler integration"
      contains: "CrawlProgressMsg"
    - path: "src/tui/styles.go"
      provides: "Lip Gloss styles and summary table renderer"
      contains: "lipgloss"
    - path: "src/main.go"
      provides: "Rewired entry point using Bubble Tea program"
      contains: "tea.NewProgram"
  key_links:
    - from: "src/tui/model.go"
      to: "src/crawler/events.go"
      via: "channel-based progress via waitForProgress pattern"
      pattern: "waitForProgress"
    - from: "src/tui/model.go"
      to: "src/crawler/crawler.go"
      via: "startCrawl tea.Cmd runs crawler.Run"
      pattern: "crawler.*Run"
    - from: "src/main.go"
      to: "src/tui/model.go"
      via: "tea.NewProgram with TUI model"
      pattern: "tea\\.NewProgram"
    - from: "src/tui/styles.go"
      to: "src/result/result.go"
      via: "renders Result into Lip Gloss table"
      pattern: "result\\.Result"
---

<objective>
Build the Bubble Tea TUI with live progress display, Lip Gloss styled summary table, and rewire main.go to use the TUI program.

Purpose: This is the core deliverable of Phase 2 -- the beautiful real-time progress display that differentiates zombiecrawl. After this plan, `zombiecrawl <url>` shows a spinner with live counters during crawl and a styled broken links table on completion.

Output: tui/ package (model.go, messages.go, styles.go), rewired main.go
</objective>

<execution_context>
@/home/luke/.claude/get-shit-done/workflows/execute-plan.md
@/home/luke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-bubble-tea-tui/02-RESEARCH.md
@.planning/phases/02-bubble-tea-tui/02-01-SUMMARY.md
@src/crawler/crawler.go
@src/crawler/events.go
@src/result/result.go
@src/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Charm dependencies and create TUI package</name>
  <files>src/tui/messages.go, src/tui/styles.go, src/tui/model.go</files>
  <action>
First, install Charm ecosystem dependencies:
```bash
cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go get github.com/charmbracelet/bubbletea@latest github.com/charmbracelet/lipgloss@latest github.com/charmbracelet/bubbles@latest
```

Create src/tui/messages.go:
- Package `tui`
- CrawlProgressMsg struct: Checked int, Broken int, URL string (maps from CrawlEvent)
- CrawlDoneMsg struct: Result *result.Result, Err error
- waitForProgress function: takes `<-chan crawler.CrawlEvent`, returns tea.Cmd. The Cmd reads one event from the channel and converts it to CrawlProgressMsg. If channel is closed, return CrawlDoneMsg with nil Result (signals channel end -- the actual result comes from startCrawl).

Create src/tui/styles.go:
- Package `tui`
- Define Lip Gloss styles: titleStyle (bold), successStyle (bold, green/color "10"), errorStyle (bold, red/color "9"), headerStyle (bold, blue/color "12"), dimStyle (faint, for URL currently being checked)
- RenderSummary function: takes *result.Result, returns string
  - If no broken links: return successStyle.Render("No broken links found!") + newline + stats line (checked N URLs in duration)
  - If broken links: build a lipgloss/table with columns "URL", "Status", "Found On". Use RoundedBorder(). Style header row with headerStyle, data rows with errorStyle. Below the table, render stats: "Found N broken links out of M URLs checked (duration)"
  - Import lipgloss and lipgloss/table

Create src/tui/model.go:
- Package `tui`
- Model struct (exported -- main.go needs to type-assert after p.Run()): ctx context.Context, cancel context.CancelFunc, crawlerInstance *crawler.Crawler, spinner spinner.Model, progressCh <-chan crawler.CrawlEvent, checked int, broken int, current string, done bool, result *result.Result, err error, width int
- NewModel function (exported): takes ctx, cancel, crawler instance, progress channel. Returns Model. Initialize spinner with spinner.Dot style, foreground color "205" (pink).
- Init() method: return tea.Batch(m.spinner.Tick, m.startCrawl(), waitForProgress(m.progressCh))
- startCrawl() method: returns tea.Cmd that calls m.crawlerInstance.Run(m.ctx) and returns CrawlDoneMsg with the result
- Update() method handles:
  - tea.KeyMsg: if "ctrl+c" or "q", set m.quitting=true, call m.cancel(), return m, tea.Quit
  - tea.WindowSizeMsg: store width for table rendering
  - CrawlProgressMsg: update m.checked, m.broken, m.current. Return m, waitForProgress(m.progressCh) (re-subscribe pattern per research pitfall #2)
  - CrawlDoneMsg: set m.done=true, m.result=msg.Result, m.err=msg.Err, return m, tea.Quit
  - spinner.TickMsg: forward to m.spinner.Update()
- View() method:
  - If m.done and m.result != nil: return RenderSummary(m.result)
  - If m.done and m.err != nil: return errorStyle.Render("Error: " + m.err.Error())
  - Otherwise (crawling): return spinner.View() + " Crawling... checked " + checked count + ", broken " + broken count + newline + dimStyle.Render("  " + m.current)
- HasBrokenLinks() method (exported): returns bool, true if result != nil and len(result.BrokenLinks) > 0

Important: Do NOT use tea.WithAltScreen() -- inline mode keeps the summary visible after exit (per research pitfall #5).
  </action>
  <verify>
Run `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go vet ./tui/...` -- must pass.
Run `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go build ./tui/...` -- must compile.
  </verify>
  <done>tui package compiles. Model implements tea.Model interface (Init/Update/View). Messages defined. Styles and RenderSummary function produce styled output. Spinner configured.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire main.go to use Bubble Tea program</name>
  <files>src/main.go</files>
  <action>
Rewrite main.go to integrate the Bubble Tea TUI:

1. Keep existing flag parsing (lines 18-27) and URL validation (lines 29-34) exactly as-is.

2. Replace the signal handling and crawler execution (lines 36-62) with:
   - Create context with cancel: `ctx, cancel := context.WithCancel(context.Background())`
   - defer cancel()
   - Create buffered progress channel: `progressCh := make(chan crawler.CrawlEvent, 100)`
   - Create crawler: `c := crawler.New(cfg, progressCh)`
   - Create TUI model: `m := tui.NewModel(ctx, cancel, c, progressCh)`
   - Create program: `p := tea.NewProgram(m)` (NO WithAltScreen, NO WithContext -- context is managed via the model's cancel function)
   - Run: `finalModel, err := p.Run()`
   - If err != nil: fmt.Fprintf(os.Stderr, "Error: %v\n", err); os.Exit(1)
   - Type assert: `fm := finalModel.(tui.Model)`
   - If fm.HasBrokenLinks(): os.Exit(1)

3. Remove the old `result.PrintResults` call -- the TUI View() handles output now.

4. Remove the `signal.NotifyContext` usage -- Bubble Tea handles Ctrl+C via KeyMsg, and the model's cancel func propagates to the crawler context.

5. Update imports: add bubbletea and tui packages, remove signal/syscall if unused, remove result import.

6. Keep the "fmt" and "os" imports for stderr error output and os.Exit.
  </action>
  <verify>
Run `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go build -o /tmp/zombiecrawl .` -- must compile.
Run `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go vet ./...` -- must pass for entire module.
  </verify>
  <done>main.go uses Bubble Tea program. Compiles cleanly. No direct stdout writes during crawl. Exit codes set based on HasBrokenLinks().</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify TUI displays correctly</name>
  <files>src/main.go</files>
  <action>
Human visual verification of the complete Bubble Tea TUI integration. Build and run against a test site to verify:
- Live spinner with progress counters during crawl
- Lip Gloss styled summary table on completion
- Ctrl+C graceful shutdown
- Correct exit codes

Steps:
1. Build: `cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go build -o /tmp/zombiecrawl .`
2. Run: `/tmp/zombiecrawl https://example.com`
3. During crawl: spinner animation with "Crawling... checked N, broken N" updating live, current URL in dim text
4. After completion: styled summary -- green "No broken links found!" or bordered table with URL/Status/Found On columns
5. Ctrl+C test: run against larger site, press Ctrl+C, verify graceful stop (no hang, no garbled terminal)
6. Exit code: `echo $?` shows 0 for clean, 1 for broken links
  </action>
  <verify>User confirms visual output meets expectations and exit codes are correct.</verify>
  <done>User approves TUI appearance, progress display, summary rendering, Ctrl+C behavior, and exit codes.</done>
</task>

</tasks>

<verification>
1. `cd src && go build -o /dev/null .` compiles
2. `cd src && go vet ./...` passes
3. Running `zombiecrawl https://example.com` shows TUI spinner during crawl
4. Completion shows Lip Gloss styled summary (table or success message)
5. Ctrl+C stops crawl gracefully
6. Exit code 0 for no broken links, 1 for broken links
</verification>

<success_criteria>
- Live TUI displays spinner + counters during crawl (OUTP-01)
- Pretty Lip Gloss summary table renders after completion (OUTP-02)
- Ctrl+C gracefully stops crawl without terminal corruption
- Exit code 0 when no broken links (OUTP-05)
- Exit code 1 when broken links found (OUTP-06)
</success_criteria>

<output>
After completion, create `.planning/phases/02-bubble-tea-tui/02-02-SUMMARY.md`
</output>
