---
phase: 03-politeness-reliability
plan: 04
type: execute
wave: 3
depends_on:
  - "03-03"
files_modified:
  - src/main.go
  - src/tui/styles.go
  - src/tui/model.go
  - src/result/printer.go
autonomous: true
requirements:
  - DETC-08

must_haves:
  truths:
    - "Broken links are displayed grouped by error category"
    - "Each broken link shows its source page"
    - "User can configure rate limit, retries, and user-agent via CLI flags"
  artifacts:
    - path: "src/main.go"
      provides: "CLI flags for --rate-limit, --retries, --retry-delay, --user-agent"
      contains: "rate-limit"
    - path: "src/tui/styles.go"
      provides: "Grouped error display in RenderSummary"
      contains: "CategoryTimeout"
  key_links:
    - from: "src/main.go"
      to: "src/crawler/worker.go"
      via: "Config struct with new fields"
      pattern: "RateLimit|Retries|UserAgent"
    - from: "src/tui/styles.go"
      to: "src/result/errors.go"
      via: "ErrorCategory type usage"
      pattern: "ErrorCategory"
---

<objective>
Add CLI flags for politeness settings and update TUI to display grouped error categories.

Purpose: User control over crawler behavior and improved error reporting in output.
Output: CLI flags, grouped error display in TUI.
</objective>

<execution_context>
@/home/luke/.claude/get-shit-done/workflows/execute-plan.md
@/home/luke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-politeness-reliability/03-CONTEXT.md
@.planning/phases/03-politeness-reliability/03-RESEARCH.md

@src/main.go
@src/tui/styles.go
@src/tui/model.go
@src/result/result.go
@src/result/errors.go
@src/crawler/worker.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI flags for politeness settings</name>
  <files>src/main.go, src/crawler/worker.go</files>
  <action>
Add CLI flags for user control:

1. Update `Config` struct in `src/crawler/worker.go`:
   - Add `Retries int` (default 2 for 3 total attempts)
   - Add `RetryDelay time.Duration` (default 1s base delay)
   - Already have RateLimit and UserAgent from plan 01

2. Update `DefaultConfig()` to set defaults for new fields

3. Update `src/main.go` to add CLI flags:
   ```go
   rateLimit := flag.Int("rate-limit", 10, "requests per second (default 10)")
   flag.IntVar(rateLimit, "r", 10, "requests per second")

   retries := flag.Int("retries", 2, "number of retries for transient errors (default 2 = 3 attempts)")
   flag.IntVar(retries, "n", 2, "number of retries")

   retryDelay := flag.Duration("retry-delay", 1*time.Second, "base delay between retries (default 1s)")

   userAgent := flag.String("user-agent", "zombiecrawl/1.0 (+https://github.com/lukemcguire/zombiecrawl)", "user agent string")
   flag.StringVar(userAgent, "U", "zombiecrawl/1.0 (+https://github.com/lukemcguire/zombiecrawl)", "user agent string")
   ```

4. Wire flags into Config:
   ```go
   cfg := crawler.Config{
       StartURL:       rawURL,
       Concurrency:    *concurrency,
       RequestTimeout: 10 * time.Second,
       RateLimit:      *rateLimit,
       UserAgent:      *userAgent,
       Retries:        *retries,
       RetryDelay:     *retryDelay,
   }
   ```

5. Update help text to show new flags

Do NOT add flags for depth control, JSON output, or CSV output - those belong in Phase 4.
  </action>
  <verify>
Run:
```
cd src && go run . -h
```
Verify all new flags appear in help output with correct defaults.
```
go run . -rate-limit 5 -retries 3 -user-agent "test/1.0" https://example.com
```
Verify flags are accepted.
  </verify>
  <done>
CLI flags for --rate-limit, --retries, --retry-delay, --user-agent working with correct defaults.
</done>
</task>

<task type="auto">
  <name>Task 2: Update TUI to display broken links grouped by category</name>
  <files>src/tui/styles.go</files>
  <action>
Update `RenderSummary` in `src/tui/styles.go` to group broken links by error category:

1. Group broken links by ErrorCategory:
   ```go
   grouped := make(map[result.ErrorCategory][]result.LinkResult)
   for _, link := range res.BrokenLinks {
       cat := link.ErrorCategory
       if cat == "" {
           cat = result.CategoryUnknown
       }
       grouped[cat] = append(grouped[cat], link)
   }
   ```

2. Define category display order (most to least actionable):
   ```go
   categoryOrder := []result.ErrorCategory{
       result.Category4xx,
       result.Category5xx,
       result.CategoryTimeout,
       result.CategoryDNSFailure,
       result.CategoryConnectionRefused,
       result.CategoryRedirectLoop,
       result.CategoryUnknown,
   }
   ```

3. For each category in order (if links exist):
   - Print category header: `## {FormatCategory(cat)} ({count})`
   - Print each link with URL, status/error, and source page
   - Use indentation for readability

4. Example output format:
   ```
   ## Client Errors (4xx) (2)
     URL: https://example.com/missing
     Status: 404
     Found on: https://example.com/page

     URL: https://example.com/forbidden
     Status: 403
     Found on: https://example.com/page

   ## Timeouts (1)
     URL: https://slow.example.com/api
     Error: context deadline exceeded
     Found on: https://example.com/page

   Found 3 broken links out of 50 URLs checked (2.5s)
   ```

5. Use Lip Gloss styles:
   - Category headers: bold with color
   - URLs: normal text
   - Status/Error: errorStyle
   - Found on: dimStyle

6. Keep the summary stats at the end

7. Handle empty categories gracefully
  </action>
  <verify>
Run:
```
cd src && go run . https://scrape-me.dreamsofcode.io/
```
Verify broken links are grouped by category in the output.
  </verify>
  <done>
Broken links displayed grouped by error category with readable formatting, source pages shown for each.
</done>
</task>

</tasks>

<verification>
- `go test ./...` passes
- CLI flags working: --rate-limit, --retries, --retry-delay, --user-agent
- TUI displays broken links grouped by category
- Each broken link shows URL, status/error, and source page
</verification>

<success_criteria>
- All CLI flags functional with correct defaults
- Grouped error display working in TUI
- Source pages visible for each broken link
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-politeness-reliability/03-04-SUMMARY.md`
</output>
