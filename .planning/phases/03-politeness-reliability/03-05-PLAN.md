---
phase: 03-politeness-reliability
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.go
  - src/crawler/crawler.go
autonomous: true
gap_closure: true
requirements: []
must_haves:
  truths:
    - "CLI help output is clean with single entry per flag and correct defaults"
    - "-retries flag controls retry attempts including explicit zero"
  artifacts:
    - path: "src/main.go"
      provides: "CLI flag parsing without duplicates"
      contains: "flag.IntVar.*concurrency"
    - path: "src/crawler/crawler.go"
      provides: "Default concurrency of 10"
      contains: "cfg.Concurrency = 10"
  key_links:
    - from: "src/main.go"
      to: "crawler.Config"
      via: "RetryPolicy struct initialization"
      pattern: "RetryPolicy.*MaxRetries.*retries"
---

<objective>
Fix CLI flag handling issues identified in UAT: duplicate flag definitions causing ugly help output, wrong default concurrency, and -retries flag not passing values through correctly.

Purpose: Clean CLI UX and correct flag behavior
Output: Fixed main.go and crawler.go
</objective>

<execution_context>
@/home/luke/.claude/get-shit-done/workflows/execute-plan.md
@/home/luke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-politeness-reliability/03-UAT.md
</context>

<tasks>

<task type="auto">
<name>Task 1: Fix duplicate flag definitions in main.go</name>
<files>src/main.go</files>
<action>
Remove duplicate flag definitions. The current code uses both `flag.Int()` and `flag.IntVar()` for the same variables, which creates duplicate entries in help output.

Current problematic pattern (lines 18-30):
```go
concurrency := flag.Int("c", 17, "number of concurrent workers")
flag.IntVar(concurrency, "concurrency", 17, "number of concurrent workers")
```

This creates TWO flag entries. Go's standard flag package does NOT support short/long aliases natively.

Solution: Use ONLY `flag.IntVar` with the long-form flag name. Users can use `-c` as a shorthand because Go allows prefix matching (e.g., `-concurrency` can be invoked as `-c` if `-c` is not registered separately).

Replace the flag section with:
```go
concurrency := flag.Int("concurrency", 10, "number of concurrent workers (default 10)")
rateLimit := flag.Int("rate-limit", 10, "requests per second (default 10)")
retries := flag.Int("retries", 2, "number of retries for transient errors (default 2 = 3 attempts)")
retryDelay := flag.Duration("retry-delay", time.Second, "base delay between retries (default 1s)")
userAgent := flag.String("user-agent", "zombiecrawl/1.0 (+https://github.com/lukemcguire/zombiecrawl)", "user agent string")
```

Key changes:
1. Remove ALL duplicate `flag.Int`/`flag.StringVar` pairs
2. Use only long-form flag names (concurrency, rate-limit, retries, user-agent)
3. Fix default concurrency from 17 to 10
4. Remove "(default X)" from description since flag package adds it automatically
5. Go's flag package allows prefix matching, so `-c` will match `-concurrency` if no `-c` flag exists

IMPORTANT: Do NOT use both flag.Int and flag.IntVar for the same variable - this is the root cause of the duplicate help entries.
</action>
<verify>
cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go build -o zombiecrawl . && ./zombiecrawl -h 2>&1 | head -20
</verify>
<done>
Help output shows single entry per flag, no duplicate defaults, and default concurrency is 10
</done>
</task>

<task type="auto">
<name>Task 2: Fix default concurrency in crawler.go</name>
<files>src/crawler/crawler.go</files>
<action>
Change the default concurrency from 17 to 10 on line 38.

Current:
```go
if cfg.Concurrency <= 0 {
    cfg.Concurrency = 17
}
```

Change to:
```go
if cfg.Concurrency <= 0 {
    cfg.Concurrency = 10
}
```

This matches the user's expected default from the CONTEXT.md decision: "10 concurrent workers by default (balanced I/O efficiency)".
</action>
<verify>
grep -n "cfg.Concurrency = " /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src/crawler/crawler.go | grep -v "//"
</verify>
<done>
Line shows cfg.Concurrency = 10 (not 17)
</done>
</task>

<task type="auto">
<name>Task 3: Fix -retries flag to pass through values including zero</name>
<files>src/crawler/crawler.go</files>
<action>
Fix the zero-value check on line 49 that prevents explicit `-retries 0` from working.

Current problematic code:
```go
if cfg.RetryPolicy.MaxRetries == 0 {
    cfg.RetryPolicy = DefaultRetryPolicy()
}
```

This conflates "unset" (zero value from struct initialization) with "explicitly set to 0".

Solution: Change the default value check to use a sentinel value. Since main.go already sets retries to 2 by default, the zero check should ONLY apply when the value is actually unset (which can't happen with current main.go, but we should make the logic correct).

The simplest fix: Change the condition to check for a negative sentinel, and have main.go pass -1 when unset (not applicable here since main.go always sets a value).

BUT the real issue is simpler: main.go already sets `MaxRetries: *retries` where retries defaults to 2. The crawler's zero-check only triggers if someone passes `-retries 0`, which should mean "no retries".

The fix is to distinguish "use default" from "explicitly zero". Since main.go now properly passes the flag value, the crawler should NOT override an explicit zero.

Change line 49-51 from:
```go
if cfg.RetryPolicy.MaxRetries == 0 {
    cfg.RetryPolicy = DefaultRetryPolicy()
}
```

To:
```go
if cfg.RetryPolicy.MaxRetries < 0 {
    cfg.RetryPolicy = DefaultRetryPolicy()
}
```

This way:
- Default from main.go (2) works fine
- Explicit `-retries 0` works (no retries, 1 attempt only)
- Explicit `-retries 1` works (1 retry, 2 attempts)

Note: The DefaultRetryPolicy() is still available as a fallback if someone passes a negative value, but with proper CLI defaults this won't trigger.
</action>
<verify>
cd /home/luke/workspace/github.com/lukemcguire/vibraphone-template/src && go build -o zombiecrawl . && echo "Testing -retries 0..." && timeout 2 ./zombiecrawl -retries 0 http://example.com 2>&1 || true
</verify>
<done>
-retries 0 is accepted without being overridden to 2
</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd src && go build .`
2. Help output is clean: `./zombiecrawl -h` shows single entry per flag
3. Default concurrency is 10: `./zombiecrawl -h` shows `(default 10)` for concurrency
4. -retries 0 works: No "(after 3 attempts)" message when retries is 0
</verification>

<success_criteria>
- Help output shows each flag once (no duplicates)
- Default concurrency is 10, not 17
- `-retries 0` results in single attempt (no retries)
- `-retries 2` works as before (2 retries = 3 attempts)
</success_criteria>

<output>
After completion, create `.planning/phases/03-politeness-reliability/03-05-SUMMARY.md`
</output>
