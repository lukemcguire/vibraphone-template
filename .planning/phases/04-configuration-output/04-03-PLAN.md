---
phase: 04-configuration-output
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - src/main.go
autonomous: true
requirements:
  - CRWL-05
  - OUTP-03
  - OUTP-04

must_haves:
  truths:
    - "User can run zombiecrawl --depth 1 <url> to limit crawl depth"
    - "User can run zombiecrawl --json <url> to get JSON output"
    - "User can run zombiecrawl --csv <url> to get CSV output"
    - "User can run zombiecrawl --json -o results.json <url> to save to file"
    - "Specifying both --json and --csv shows error and exits"
    - "TUI always displays regardless of output format flags"
    - "File output is written after crawl completes"
  artifacts:
    - path: "src/main.go"
      provides: "CLI flag definitions and output integration"
      contains: '"depth"'
      contains: '"json"'
      contains: '"csv"'
      contains: '"output"'
  key_links:
    - from: "src/main.go"
      to: "src/crawler/crawler.go"
      via: "Config.MaxDepth"
      pattern: "MaxDepth:"
    - from: "src/main.go"
      to: "src/result/output.go"
      via: "result.WriteJSON, result.WriteCSV"
      pattern: "result\\.Write"
---

<objective>
Integrate depth control and structured output flags into the CLI entry point.

Purpose: Expose Phase 4 features to users via command-line flags with proper validation and output handling.
Output: Updated main.go with -d/--depth, -j/--json, -c/--csv, and -o/--output flags.
</objective>

<execution_context>
@/home/luke/.claude/get-shit-done/workflows/execute-plan.md
@/home/luke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration-output/04-CONTEXT.md
@.planning/phases/04-configuration-output/04-RESEARCH.md
@src/main.go
@src/crawler/crawler.go
@src/result/output.go
@.planning/phases/04-configuration-output/04-01-SUMMARY.md
@.planning/phases/04-configuration-output/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add depth flag and pass to crawler Config</name>
  <files>src/main.go</files>
  <action>
Add the depth flag to main.go using flag.IntVar for both short and long forms:

```go
var depth int
flag.IntVar(&depth, "d", 0, "maximum crawl depth (0 = unlimited)")
flag.IntVar(&depth, "depth", 0, "maximum crawl depth (0 = unlimited)")
```

Add `MaxDepth: depth` to the `crawler.Config` struct initialization.

Per user decisions:
- Flag style: both short (-d) and long (--depth) forms
- Default: 0 (unlimited)
- Depth applies to same-domain only (enforced by crawler, not CLI)
  </action>
  <verify>
grep -q '"d".*depth' src/main.go && grep -q "MaxDepth.*depth" src/main.go && echo "Depth flag added"
  </verify>
  <done>
CLI accepts -d/--depth flag and passes value to crawler Config.MaxDepth.
  </done>
</task>

<task type="auto">
  <name>Add JSON, CSV, and output file flags with validation</name>
  <files>src/main.go</files>
  <action>
Add output-related flags to main.go:

```go
var outputJSON bool
flag.BoolVar(&outputJSON, "j", false, "output results as JSON")
flag.BoolVar(&outputJSON, "json", false, "output results as JSON")

var outputCSV bool
flag.BoolVar(&outputCSV, "c", false, "output results as CSV")
flag.BoolVar(&outputCSV, "csv", false, "output results as CSV")

var outputFile string
flag.StringVar(&outputFile, "o", "", "write JSON/CSV output to file")
flag.StringVar(&outputFile, "output", "", "write JSON/CSV output to file")
```

After flag.Parse(), add validation:

```go
if outputJSON && outputCSV {
    fmt.Fprintln(os.Stderr, "Error: --json and --csv are mutually exclusive")
    os.Exit(1)
}
```

Per user/research decisions:
- Short flags: -j for JSON, -c for CSV, -o for output (Claude's discretion)
- Both --json and --csv: Error and exit (mutually exclusive)
  </action>
  <verify>
grep -q '"j".*json' src/main.go && grep -q '"c".*csv' src/main.go && grep -q '"o".*output' src/main.go && grep -q "mutually exclusive" src/main.go && echo "Output flags added"
  </verify>
  <done>
CLI accepts -j/--json, -c/--csv, and -o/--output flags with mutual exclusion validation.
  </done>
</task>

<task type="auto">
  <name>Write output after TUI completes</name>
  <files>src/main.go</files>
  <action>
After the TUI completes (after `program.Run()` returns), add code to write output if requested:

Per user decisions:
- TUI always displays (beautiful output is core value)
- File output is written AFTER crawl completion
- Silently overwrite existing files (use os.Create which truncates)
- If -o specified without --json or --csv, default to JSON

Implementation approach:
1. Check if outputJSON, outputCSV, or outputFile is set
2. If no format specified but outputFile is set, default to JSON
3. Get results from finalTUIModel (need to add getter method if not present)
4. If outputFile is set, open file with os.Create (overwrites silently)
5. Call result.WriteJSON or result.WriteCSV with appropriate io.Writer
6. If no outputFile but format is set, write to os.Stdout

Add import for `io` if needed, and import the result package functions.

Check if tui.Model has a method to get the result. If not, access the result field directly (it should be exported or have a getter from Phase 2/3).
  </action>
  <verify>
grep -q "WriteJSON\|WriteCSV" src/main.go && grep -q "finalTUIModel" src/main.go && echo "Output writing added"
  </verify>
  <done>
CLI writes JSON or CSV output after TUI completes, either to stdout or specified file.
  </done>
</task>

</tasks>

<verification>
- `go build ./...` compiles without errors
- `go test ./...` passes
- `zombiecrawl --help` shows new flags
- `zombiecrawl --json --csv <url>` exits with error message
- `zombiecrawl --depth 1 <url>` limits crawl depth
</verification>

<success_criteria>
- CLI accepts -d/--depth flag and passes to crawler
- CLI accepts -j/--json and -c/--csv flags (mutually exclusive)
- CLI accepts -o/--output flag for file output
- TUI always displays regardless of output format
- JSON/CSV output written after crawl completes
- File output silently overwrites existing files
- If -o without --json/--csv, defaults to JSON
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration-output/04-03-SUMMARY.md`
</output>
