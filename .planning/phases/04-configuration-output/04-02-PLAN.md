---
phase: 04-configuration-output
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/result/result.go
  - src/result/output.go
autonomous: true
requirements:
  - OUTP-03
  - OUTP-04

must_haves:
  truths:
    - "User can get JSON output with --json flag"
    - "User can get CSV output with --csv flag"
    - "JSON output has status_code and error_type as separate fields"
    - "CSV output has header row even if no broken links found"
    - "Output is written at crawl completion, not during crawl"
  artifacts:
    - path: "src/result/output.go"
      provides: "JSON and CSV output functions"
      exports: ["WriteJSON", "WriteCSV"]
      min_lines: 60
    - path: "src/result/result.go"
      provides: "JSON tags on LinkResult"
      contains: 'json:"'
  key_links:
    - from: "src/result/output.go"
      to: "src/result/result.go"
      via: "LinkResult struct fields"
      pattern: "LinkResult"
---

<objective>
Create JSON and CSV output formatters for machine-readable crawl results.

Purpose: Enable automation and CI integration by providing structured output formats that can be piped to other tools or saved to files.
Output: New output.go with WriteJSON and WriteCSV functions, JSON tags added to LinkResult struct.
</objective>

<execution_context>
@/home/luke/.claude/get-shit-done/workflows/execute-plan.md
@/home/luke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration-output/04-CONTEXT.md
@.planning/phases/04-configuration-output/04-RESEARCH.md
@src/result/result.go
@src/result/errors.go
</context>

<tasks>

<task type="auto">
  <name>Add JSON tags to LinkResult struct</name>
  <files>src/result/result.go</files>
  <action>
Add JSON struct tags to the `LinkResult` struct fields for proper JSON serialization.

Per user decision: use snake_case field names in JSON output:
- `URL` -> `json:"url"`
- `StatusCode` -> `json:"status_code,omitempty"` (omitempty since 0 means no HTTP status)
- `Error` -> `json:"error,omitempty"`
- `ErrorCategory` -> `json:"error_type,omitempty"` (user specified error_type, not error_category)
- `SourcePage` -> `json:"source_page"`
- `IsExternal` -> `json:"is_external"`

Also add JSON tags to `CrawlStats` and `Result` structs for completeness (may be useful later).
  </action>
  <verify>
grep -q 'json:"url"' src/result/result.go && grep -q 'json:"status_code' src/result/result.go && echo "JSON tags added"
  </verify>
  <done>
LinkResult struct has JSON tags with snake_case field names and appropriate omitempty directives.
  </done>
</task>

<task type="auto">
  <name>Create WriteJSON function in output.go</name>
  <files>src/result/output.go</files>
  <action>
Create a new file `src/result/output.go` with a `WriteJSON` function.

Per user and research decisions:
- Use flat array format: `[]LinkResult` (not wrapped with metadata) - simpler for CI tools
- Use `encoding/json.NewEncoder` with `SetEscapeHTML(false)` for cleaner URLs
- Use `SetIndent("", "  ")` for pretty-printed output
- Function signature: `func WriteJSON(w io.Writer, links []LinkResult) error`

Import statements needed:
- `encoding/json`
- `io`
  </action>
  <verify>
grep -q "func WriteJSON" src/result/output.go && go build ./src/result/... && echo "WriteJSON created"
  </verify>
  <done>
output.go exists with WriteJSON function that writes formatted JSON array of LinkResult to io.Writer.
  </done>
</task>

<task type="auto">
  <name>Create WriteCSV function in output.go</name>
  <files>src/result/output.go</files>
  <action>
Add a `WriteCSV` function to `src/result/output.go`.

Per user and research decisions:
- Column order: `url,status_code,error_type,source_page,is_external` (Claude's discretion - most important first)
- Always write header row (even if no broken links) - user decision
- `status_code` is empty string if no HTTP status (non-HTTP errors)
- `error_type` comes from `ErrorCategory` field, empty if no error
- Use `encoding/csv.NewWriter`
- Function signature: `func WriteCSV(w io.Writer, links []LinkResult) error`

Implementation details:
1. Create csv.Writer
2. Write header row: `[]string{"url", "status_code", "error_type", "source_page", "is_external"}`
3. For each link:
   - Convert StatusCode to string (empty if 0)
   - Convert ErrorCategory to string (empty if none)
   - Convert IsExternal to "true" or "false"
4. Flush and check for errors

Add import for `fmt` if not already present (for sprintf).
  </action>
  <verify>
grep -q "func WriteCSV" src/result/output.go && grep -q "status_code" src/result/output.go && echo "WriteCSV created"
  </verify>
  <done>
output.go has WriteCSV function that writes CSV with header row and properly formatted fields to io.Writer.
  </done>
</task>

</tasks>

<verification>
- `go build ./src/result/...` compiles without errors
- `go test ./src/result/...` passes
- WriteJSON produces valid JSON array with correct field names
- WriteCSV produces valid CSV with header row
</verification>

<success_criteria>
- result.go has JSON tags on LinkResult with snake_case names
- output.go exists with WriteJSON function using flat array format
- output.go has WriteCSV function with controlled column order
- CSV always includes header row
- Both functions accept io.Writer for flexibility (stdout or file)
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration-output/04-02-SUMMARY.md`
</output>
